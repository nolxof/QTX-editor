<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø­Ø±Ø± Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ÙØ®Ù… â€” Ø¹Ø¨Ø¯Ø§Ù„Ø¥Ù„Ù‡</title>

  <!-- Fonts & Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <!-- xterm.css -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
  <!-- Simple CSS reset + neumorphism style -->
  <style>
    :root{
      --bg:#e7ecf0; --card:#edf2f6; --muted:#6b7280; --accent:#7c5cff;
      --glass: rgba(255,255,255,0.6);
      --shadow-1: 15px 15px 30px rgba(0,0,0,0.08), -10px -8px 20px rgba(255,255,255,0.8);
    }
    [data-theme="dark"]{
      --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#8b6bff;
      --glass: rgba(255,255,255,0.03);
      --shadow-1: 10px 10px 30px rgba(0,0,0,0.6), -6px -6px 18px rgba(255,255,255,0.02);
    }
    html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Tahoma, Arial; background:linear-gradient(180deg,var(--bg), #dfe7ef); transition:background .3s}
    .app{display:flex;flex-direction:column;height:100vh;padding:18px;box-sizing:border-box;gap:14px}
    .topbar{display:flex;align-items:center;gap:12px;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#4cd3ff);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;
      box-shadow: var(--shadow-1);
    }
    .controls{display:flex;align-items:center;gap:10px}
    .select, .btn {
      border:none;padding:10px 14px;border-radius:12px;background:var(--card);box-shadow:var(--shadow-1);cursor:pointer;font-weight:600;
      transition:transform .12s, box-shadow .12s;
    }
    .select:active, .btn:active{transform:translateY(2px)}
    .btn.secondary{background:transparent;box-shadow:none;color:var(--muted);font-weight:600}
    .main{display:grid;grid-template-columns:0.55fr 0.45fr;gap:16px;flex:1;min-height:0}
    .editor-area{display:flex;flex-direction:column;border-radius:14px;padding:10px;background:var(--glass);backdrop-filter: blur(6px);box-shadow:var(--shadow-1);overflow:hidden}
    .tabs{display:flex;gap:8px;padding:8px;border-radius:10px}
    .tab{padding:8px 12px;border-radius:10px;background:var(--card);cursor:pointer;box-shadow:8px 8px 20px rgba(0,0,0,0.04)}
    .split{display:flex;flex-direction:column;gap:10px;height:100%}
    #monaco-editor{flex:1;border-radius:10px;overflow:hidden}
    .right-panel{display:flex;flex-direction:column;gap:10px}
    .preview, .terminal{flex:1;border-radius:12px;padding:10px;background:var(--card);box-shadow:var(--shadow-1);overflow:hidden;display:flex;flex-direction:column}
    .preview iframe{border:0;flex:1;width:100%;border-radius:8px}
    .term-actions{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    /* file list */
    .files{display:flex;flex-direction:column;gap:8px;padding:8px;border-radius:10px;max-height:180px;overflow:auto}
    .file-item{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;background:linear-gradient(180deg,var(--card),transparent);cursor:pointer}
    .file-item.active{outline:2px solid rgba(124,92,255,0.14)}
    /* neumorphism buttons */
    .neum{border-radius:14px;padding:10px 14px;background:var(--card);box-shadow:var(--shadow-1);transition:transform .12s}
    .small{padding:6px 10px;font-size:13px}
    /* responsive */
    @media (max-width:900px){
      .main{grid-template-columns:1fr;grid-auto-rows:minmax(200px,1fr)}
      .brand .title{display:none}
      .files{max-height:120px}
    }
    /* small helper */
    .muted{color:var(--muted);font-size:13px}
    .fade-in{animation:fadeIn .35s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  </style>
</head>
<body data-theme="light">
  <div class="app">
    <div class="topbar fade-in">
      <div class="brand">
        <div class="logo">AE</div>
        <div>
          <div style="font-weight:800">Abdelilah Editor</div>
          <div class="muted" style="font-size:12px">Ù…Ø­Ø±Ø± Ø£ÙƒÙˆØ§Ø¯ ÙŠØ¬Ø±ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­ â€” Ø¨Ø¯ÙˆÙ† Backend</div>
        </div>
      </div>

      <div class="controls">
        <select id="langSelect" class="select" title="Ø§Ø®ØªØ± Ù„ØºØ©">
          <option value="html">HTML</option>
          <option value="javascript" selected>JavaScript</option>
          <option value="python">Python (Pyodide)</option>
          <option value="cpp">C++ (WASM - placeholder)</option>
          <option value="java">Java (WASM - placeholder)</option>
          <option value="go">Go (WASM - placeholder)</option>
        </select>

        <button id="runBtn" class="btn neom">Run <i class="fa-solid fa-play" style="margin-inline-start:8px"></i></button>
        <button id="stopBtn" class="btn neom">Stop <i class="fa-solid fa-stop" style="margin-inline-start:8px"></i></button>
        <button id="saveBtn" class="btn neom">Save</button>
        <button id="downloadBtn" class="btn neom">Download ZIP</button>
        <button id="themeToggle" class="btn secondary">ğŸŒ™</button>
      </div>
    </div>

    <div class="main">
      <div class="editor-area fade-in">
        <div class="tabs" id="tabs"></div>
        <div class="split" style="padding:8px;gap:8px">
          <div style="display:flex;gap:10px;align-items:center">
            <div class="files" id="fileList" style="flex:1"></div>
            <div style="display:flex;flex-direction:column;gap:6px">
              <button id="newFile" class="neum small">+ Ù…Ù„Ù</button>
              <button id="importBtn" class="neum small">Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
              <input type="file" id="importInput" style="display:none" multiple />
            </div>
          </div>
          <div id="monaco-editor"></div>
        </div>
      </div>

      <div class="right-panel">
        <div class="preview fade-in">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <div style="font-weight:700">Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© / Ø§Ù„Ù†ØªØ§Ø¦Ø¬</div>
            <div class="muted">Live Preview & Console</div>
          </div>
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <button id="showPreview" class="neum small">Ù…Ø¹Ø§ÙŠÙ†Ø© HTML</button>
            <button id="clearConsole" class="neum small">Ù…Ø³Ø­ Ø§Ù„Ø·Ø±ÙÙŠØ©</button>
          </div>
          <div style="display:flex;gap:8px;flex:1;min-height:0">
            <div class="preview-frame" style="flex:1;display:flex;flex-direction:column;min-height:0">
              <iframe id="previewFrame"></iframe>
            </div>
            <div class="terminal" style="width:420px;min-width:280px">
              <div class="term-actions">
                <div style="font-weight:700">Ø§Ù„Ø·Ø±ÙÙŠØ©</div>
                <div style="flex:1"></div>
                <div class="muted">Ø§ÙƒØªØ¨ Ø£ÙˆØ§Ù…Ø± Ù…Ø«Ù„: <code>run</code> Ø£Ùˆ <code>python script.py</code></div>
              </div>
              <div id="terminalContainer" style="flex:1;min-height:0"></div>
            </div>
          </div>
        </div>

        <div style="display:flex;gap:10px;align-items:center">
          <div class="muted">Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ:</div>
          <div id="autosaveStatus" class="muted">--</div>
          <div style="flex:1"></div>
          <div class="muted">Ø­Ø¬Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:</div>
          <div id="projectSize" class="muted">0 KB</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Libraries: Monaco loader, xterm, JSZip, Pyodide (deferred), WebContainer (attempt) -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.39.0/min/vs/loader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <script>
  /***********************
   * Helper -- in-memory FS + project management
   ***********************/
  const PROJECT_KEY = 'abdelilah.editor.project.v1';
  let FS = {}; // { "index.html": "..." }
  let activeFile = null;
  let monacoEditor = null;
  let monacoModels = {};
  let pyodide = null;
  let webcontainer = null;
  let term = null;
  let autosaveTimer = null;

  // default starter project
  const DEFAULT_PROJECT = {
    "index.html": `<!doctype html>
<html>
  <head><meta charset="utf-8"><title>Preview</title></head>
  <body>
    <h1 style="font-family:sans-serif;color:#333">Ù…Ø±Ø­Ø¨Ù‹Ø§ â€” Ù…Ø¹Ø§ÙŠÙ†Ø© HTML</h1>
    <p>Ø¹Ø¯Ù‘Ù„ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ø¶ØºØ· Run.</p>
  </body>
</html>`,
    "script.js": `// JavaScript output to console
console.log("Hello from script.js");
// DOM example (works in preview)
document.body.style.background = "linear-gradient(180deg,#ffffff,#f3f6ff)";
`,
    "style.css": `body{font-family:system-ui,Segoe UI,Arial;background:#fff;margin:40px}`
  };

  function saveProjectToLocal(){
    try{
      localStorage.setItem(PROJECT_KEY, JSON.stringify(FS));
      document.getElementById('autosaveStatus').textContent = 'ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ âœ“';
      updateProjectSize();
    }catch(e){
      console.error(e);
      document.getElementById('autosaveStatus').textContent = 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸';
    }
  }
  function loadProjectFromLocal(){
    const raw = localStorage.getItem(PROJECT_KEY);
    if(raw){
      try{ FS = JSON.parse(raw); return true }catch(e){ console.warn('invalid project'); }
    }
    FS = {...DEFAULT_PROJECT};
    return false;
  }
  function updateProjectSize(){
    let total = 0;
    for(const k in FS) total += new Blob([FS[k]]).size;
    document.getElementById('projectSize').textContent = Math.round(total/1024) + ' KB';
  }

  /***********************
   * Terminal (xterm)
   ***********************/
  function initTerminal(){
    term = new Terminal({cols:80,rows:18,convertEol:true});
    term.open(document.getElementById('terminalContainer'));
    term.writeln('Ù…Ø­Ø±Ø± Ø§Ù„Ø·Ø±ÙÙŠØ© Ø¬Ø§Ù‡Ø² â€” Ø§ÙƒØªØ¨ "help" Ù„Ù„Ø®ÙŠØ§Ø±Ø§Øª.');
    term.onKey(e=>{
      // simple input handling: gather char, on Enter process buffer
      // We'll implement a very small line input handler:
    });
    // simple command input via prompt simulation:
    setupSimplePrompt();
  }

  let promptBuffer = '';
  function setupSimplePrompt(){
    term.write('\r\n$ ');
    promptBuffer = '';
    term.onData(async (data)=>{
      for(const ch of data){
        if(ch === '\r' || ch === '\n'){
          const cmd = promptBuffer.trim();
          term.writeln('');
          await handleTerminalCommand(cmd);
          term.write('\r\n$ ');
          promptBuffer = '';
        } else if (ch === '\u007F'){ // backspace
          if(promptBuffer.length>0){
            promptBuffer = promptBuffer.slice(0,-1);
            term.write('\b \b');
          }
        } else {
          promptBuffer += ch;
          term.write(ch);
        }
      }
    });
  }

  async function handleTerminalCommand(cmd){
    if(!cmd) return;
    const args = cmd.split(' ').filter(Boolean);
    const main = args[0];
    if(main === 'help'){
      term.writeln('Ø£ÙˆØ§Ù…Ø± Ù…ÙÙŠØ¯Ø©: run, ls, cat <file>, python <file>, node <file> (Ø¥Ø°Ø§ Ù…ØªØ§Ø­), g++ (ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ù…Ø­Ù„ÙŠØ§Ù‹ Ù‡Ù†Ø§)');
      return;
    }
    if(main === 'ls'){
      Object.keys(FS).forEach(f=> term.writeln(f));
      return;
    }
    if(main === 'cat'){
      if(!args[1]){ term.writeln('Ø­Ø¯Ø¯ Ù…Ù„Ù: cat filename'); return }
      const name = args[1];
      if(FS[name]) term.writeln(FS[name]);
      else term.writeln('Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: ' + name);
      return;
    }
    if(main === 'run'){
      // run default script based on language selection
      await runCurrentFile();
      return;
    }
    if(main === 'python'){
      if(!args[1]){ term.writeln('Ø­Ø¯Ø¯ Ù…Ù„Ù Python: python script.py'); return }
      const f = args[1];
      if(!FS[f]){ term.writeln('Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: ' + f); return }
      if(!pyodide){
        term.writeln('Pyodide ØºÙŠØ± Ù…ÙØ­Ù…Ù„ Ø¨Ø¹Ø¯ â€” Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...');
        await loadPyodide();
      }
      try{
        term.writeln('ØªØ´ØºÙŠÙ„ Python -> ' + f);
        const output = await pyodide.runPythonAsync(FS[f]);
        if(output !== undefined) term.writeln(String(output));
      }catch(e){ term.writeln('Ø®Ø·Ø£: ' + e); }
      return;
    }
    if(main === 'node'){
      if(!args[1]){ term.writeln('Ø­Ø¯Ø¯ Ù…Ù„Ù JS: node file.js'); return }
      const f = args[1];
      if(!FS[f]){ term.writeln('Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: ' + f); return }
      if(!webcontainer){
        term.writeln('WebContainer/Node ØºÙŠØ± Ù…ØªØ§Ø­ Ù‡Ù†Ø§. Ø³Ø£Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¨Ø¯Ø¡ (Ø¥Ù† Ø£Ù…ÙƒÙ†)...');
        await tryStartWebContainer();
        if(!webcontainer){ term.writeln('ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ WebContainer ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­/Ø§Ù„ØµÙØ­Ø©.'); return }
      }
      try{
        term.writeln('ØªØ´ØºÙŠÙ„ ÙÙŠ WebContainer: ' + f);
        // create file and run node - this is a best-effort integration
        await webcontainer.fs.writeFile('/' + f, FS[f]);
        const proc = await webcontainer.spawn('node', [f]);
        const stdout = await proc.output();
        term.writeln(stdout.toString());
      }catch(e){ term.writeln('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ´ØºÙŠÙ„ Node: ' + e.message) }
      return;
    }
    if(main === 'g++' || main === 'gcc'){
      term.writeln('ØªØ­Ø°ÙŠØ±: ØªØ±Ø¬Ù…Ø© C/C++ Ù„ÙŠØ³Øª Ù…Ø¶Ù…Ù‘Ù†Ø© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø©. Ù„ØªÙ…ÙƒÙŠÙ†Ù‡Ø§ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ WASM toolchain (Ù…Ø«Ù„ clang-wasm Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø¯Ù…Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ©).');
      return;
    }
    term.writeln('Ø£Ù…Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ: ' + main);
  }

  /***********************
   * Monaco Editor init
   ***********************/
  function initMonaco(){
    require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.39.0/min/vs' }});
    require(['vs/editor/editor.main'], function() {
      monacoEditor = monaco.editor.create(document.getElementById('monaco-editor'), {
        value: '',
        language: 'javascript',
        theme: 'vs-dark',
        automaticLayout: true,
        fontSize: 13,
        minimap: { enabled: false }
      });
      // create models for FS
      loadProjectFromLocal();
      for(const fname in FS){
        const lang = monaco.getLanguages().map(l=>l.id).includes(extToLang(getExt(fname))) ? extToLang(getExt(fname)) : detectLangFromFilename(fname);
        const model = monaco.editor.createModel(FS[fname], lang, monaco.Uri.parse('file:///' + fname));
        monacoModels[fname] = model;
      }
      // open first file
      const first = Object.keys(FS)[0] || 'index.html';
      openFile(first);
      renderFileList();
      setupTabs();
      // update editor changes back to FS
      monacoEditor.onDidChangeModelContent(()=>{
        if(activeFile){
          FS[activeFile] = monacoEditor.getValue();
          scheduleAutosave();
        }
      });
    });
  }

  function detectLangFromFilename(fname){
    const ext = getExt(fname);
    return extToLang(ext);
  }
  function getExt(fname){ const m = fname.match(/\.([^.]+)$/); return m?m[1]:'txt'; }
  function extToLang(ext){
    ext = ext.toLowerCase();
    if(ext === 'js') return 'javascript';
    if(ext === 'html' || ext === 'htm') return 'html';
    if(ext === 'css') return 'css';
    if(ext === 'py') return 'python';
    if(ext === 'cpp' || ext === 'cc' || ext === 'c') return 'cpp';
    return 'plaintext';
  }

  function openFile(fname){
    if(!monacoModels[fname]){
      const lang = detectLangFromFilename(fname);
      const model = monaco.editor.createModel(FS[fname]||'', lang, monaco.Uri.parse('file:///' + fname));
      monacoModels[fname] = model;
    }
    monacoEditor.setModel(monacoModels[fname]);
    activeFile = fname;
    highlightActiveFile();
  }

  function renderFileList(){
    const el = document.getElementById('fileList');
    el.innerHTML = '';
    Object.keys(FS).forEach(f=>{
      const item = document.createElement('div'); item.className = 'file-item'; item.textContent = f;
      if(f === activeFile) item.classList.add('active');
      item.onclick = ()=> openFile(f);
      el.appendChild(item);
    });
  }

  function setupTabs(){
    const tabs = document.getElementById('tabs');
    tabs.innerHTML = '';
    Object.keys(FS).forEach(f=>{
      const t = document.createElement('div'); t.className = 'tab'; t.textContent = f;
      t.onclick = ()=> openFile(f);
      tabs.appendChild(t);
    });
  }

  /***********************
   * Run / Preview / Stop
   ***********************/
  function showPreview(){
    // Build an HTML page by injecting style.css and script.js if present, plus index.html content
    const html = FS['index.html'] || (FS['index.htm'] || null);
    if(!html){
      // if no index, create simple preview from JS/HTML
      const base = `<!doctype html><html><head><meta charset="utf-8"></head><body><pre>Ù„Ø§ ÙŠÙˆØ¬Ø¯ index.html ÙÙŠ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</pre></body></html>`;
      writePreview(base);
      return;
    }
    const style = FS['style.css'] ? `<style>\n${FS['style.css']}\n</style>` : '';
    const script = FS['script.js'] ? `<script>\ntry{ ${FS['script.js']} }catch(e){ console.error(e) }\n</script>` : '';
    // if index.html already contains its own CSS/JS, prefer it but still inject
    let final = html;
    // Naive injection: put style before </head>, script before </body>
    final = final.replace(/<\/head>/i, style + '\n</head>');
    final = final.replace(/<\/body>/i, script + '\n</body>');
    writePreview(final);
  }
  function writePreview(content){
    const iframe = document.getElementById('previewFrame');
    const doc = iframe.contentWindow.document;
    doc.open();
    doc.write(content);
    doc.close();
    // capture console logs from iframe
    hookPreviewConsole(iframe);
  }

  function hookPreviewConsole(iframe){
    try{
      const win = iframe.contentWindow;
      // override console
      win.console.log = function(...args){
        term.writeln('[Preview] ' + args.map(a=>String(a)).join(' '));
      };
      win.console.error = function(...args){
        term.writeln('[Preview][Error] ' + args.join(' '));
      };
    }catch(e){ /* cross-origin might block */ }
  }

  async function runCurrentFile(){
    const ext = getExt(activeFile||'script.js');
    if(ext === 'html' || activeFile === 'index.html'){
      showPreview();
      term.writeln('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©.');
      return;
    }
    if(ext === 'js'){
      // run using Function, capture console
      const code = FS[activeFile];
      term.writeln('ØªØ´ØºÙŠÙ„ JavaScript: ' + activeFile);
      // sandboxed Function
      try{
        const consoleProxy = {
          log: (...args)=> term.writeln('[log] ' + args.map(a=>String(a)).join(' ')),
          error: (...args)=> term.writeln('[error] ' + args.join(' '))
        };
        const AsyncFunction = Object.getPrototypeOf(async function(){}).constructor;
        const fn = new AsyncFunction('console', code);
        await fn(consoleProxy);
        term.writeln('Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªÙ†ÙÙŠØ°.');
      }catch(e){ term.writeln('Ø®Ø·Ø£: ' + e); }
      return;
    }
    if(ext === 'py'){
      if(!pyodide){ term.writeln('Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Pyodide...'); await loadPyodide(); }
      try{
        term.writeln('ØªØ´ØºÙŠÙ„ Python: ' + activeFile);
        const out = await pyodide.runPythonAsync(FS[activeFile]);
        if(out !== undefined) term.writeln(String(out));
      }catch(e){ term.writeln('Ø®Ø·Ø£ Python: ' + e); }
      return;
    }
    term.writeln('Ø§Ù„ØªØ´ØºÙŠÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù„ØºØ© ØºÙŠØ± Ù…ØªÙˆÙØ± Ù…Ø­Ù„ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¬Ø±Ø¨Ø© ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙˆØ§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø¯Ù…Ø§Øª Ø¬Ø§Ù‡Ø²Ø© Ø£Ùˆ Ø¥Ø¹Ø¯Ø§Ø¯ WASM toolchain.');
  }

  /***********************
   * Pyodide loader
   ***********************/
  async function loadPyodide(){
    if(pyodide) return pyodide;
    try{
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js';
      document.head.appendChild(script);
      script.onload = async ()=>{
        term.writeln('Pyodide Ù…ÙØ­Ù…Ù‘Ù„. Ø¬Ø§Ø±Ù ØªÙ‡ÙŠØ¦ØªÙ‡...');
      };
      // wait for global load
      await new Promise((res, rej)=> {
        script.onload = res;
        script.onerror = ()=> rej(new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Pyodide'));
      });
      pyodide = await loadPyodide({indexURL:'https://cdn.jsdelivr.net/pyodide/v0.23.4/full/'});
      term.writeln('Pyodide Ø¬Ø§Ù‡Ø².');
      return pyodide;
    }catch(e){
      term.writeln('Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Pyodide: ' + e.message);
      return null;
    }
  }

  /***********************
   * WebContainer (Node) attempt (best-effort)
   ***********************/
  async function tryStartWebContainer(){
    if(window.WebContainer){ // some pages expose WebContainer already
      try{
        webcontainer = await window.WebContainer.boot();
        term.writeln('WebContainer Ø¬Ø§Ù‡Ø².');
        return webcontainer;
      }catch(e){}
    }
    try{
      // attempt dynamic import from unpkg (may be blocked by CORS/policy)
      const mod = await import('https://unpkg.com/@webcontainer/api@0.8.0/dist/index.js');
      if(mod && mod.WebContainer){
        webcontainer = await mod.WebContainer.boot();
        term.writeln('WebContainer (via unpkg) Ø¬Ø§Ù‡Ø².');
        return webcontainer;
      }
    }catch(e){
      console.warn('WebContainer load error', e);
    }
    term.writeln('ØªØ¹Ø°Ø± Ø¨Ø¯Ø¡ WebContainer ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©. Ù„Ù„ØªÙ…ÙƒÙŠÙ†: Ø§Ø³ØªØ¹Ù…Ù„ StackBlitz SDK/Ø¨ÙŠØ¦Ø© ØªØ¯Ø¹Ù… WebContainer Ø£Ùˆ Ø§Ø³ØªØ¶Ù ÙƒØµÙØ­Ø© Ø¹Ù„Ù‰ origin Ù…Ø³Ù…ÙˆØ­.');
    return null;
  }

  /***********************
   * File operations: new, import, download zip
   ***********************/
  function newFile(){
    let name = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù…Ø«Ø§Ù„: main.js Ø£Ùˆ index.html):', 'new.txt');
    if(!name) return;
    if(FS[name]){ alert('Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„'); return }
    FS[name] = '';
    // create model
    if(monaco && monaco.editor){
      const model = monaco.editor.createModel(FS[name], detectLangFromFilename(name), monaco.Uri.parse('file:///' + name));
      monacoModels[name] = model;
      openFile(name);
      renderFileList(); setupTabs(); scheduleAutosave();
    }
  }

  function importFiles(files){
    Array.from(files).forEach(file=>{
      const reader = new FileReader();
      reader.onload = e=>{
        FS[file.name] = e.target.result;
        if(monaco && monaco.editor){
          const model = monaco.editor.createModel(FS[file.name], detectLangFromFilename(file.name), monaco.Uri.parse('file:///' + file.name));
          monacoModels[file.name] = model;
        }
        renderFileList(); setupTabs(); scheduleAutosave();
      };
      reader.readAsText(file);
    });
  }

  async function downloadZip(){
    const zip = new JSZip();
    for(const k in FS) zip.file(k, FS[k]);
    const content = await zip.generateAsync({type:'blob'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(content);
    a.download = 'project.zip';
    a.click();
    URL.revokeObjectURL(a.href);
  }

  /***********************
   * Autosave
   ***********************/
  function scheduleAutosave(){
    document.getElementById('autosaveStatus').textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸...';
    clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(()=>{
      // update FS from current model
      if(activeFile && monacoEditor && monacoEditor.getModel){
        FS[activeFile] = monacoEditor.getValue();
      }
      saveProjectToLocal();
    }, 800);
  }

  /***********************
   * UI wiring
   ***********************/
  document.addEventListener('DOMContentLoaded', async ()=>{
    initTerminal();
    initMonaco();

    document.getElementById('newFile').onclick = newFile;
    document.getElementById('importBtn').onclick = ()=> document.getElementById('importInput').click();
    document.getElementById('importInput').onchange = (e)=> importFiles(e.target.files);

    document.getElementById('runBtn').onclick = async ()=>{
      // sync current model to FS
      if(activeFile && monacoEditor) FS[activeFile] = monacoEditor.getValue();
      await runCurrentFile();
    };
    document.getElementById('stopBtn').onclick = ()=>{
      term.writeln('Stop pressed â€” Ù„Ø§ ØªÙ†ÙÙŠØ° Ù…ØªØ²Ø§Ù…Ù† Ù„ÙŠØªÙ… Ø¥ÙŠÙ‚Ø§ÙÙ‡ Ù‡Ù†Ø§ (Ø¥Ù† ÙˆØ¬Ø¯ proc Ø¹Ø¨Ø± WebContainer ÙŠÙ…ÙƒÙ† Ø¥Ù†Ù‡Ø§Ø¤Ù‡).');
      // extension point: if using webcontainer, we could kill processes.
    };
    document.getElementById('saveBtn').onclick = ()=>{
      if(activeFile && monacoEditor) FS[activeFile] = monacoEditor.getValue();
      saveProjectToLocal();
      renderFileList(); setupTabs();
      term.writeln('ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙŠØ¯ÙˆÙŠØ§Ù‹.');
    };
    document.getElementById('downloadBtn').onclick = downloadZip;
    document.getElementById('showPreview').onclick = showPreview;
    document.getElementById('clearConsole').onclick = ()=> { term.clear(); term.writeln('Ø·Ø±ÙÙŠØ© Ù†Ø¸ÙŠÙØ©'); };

    document.getElementById('langSelect').onchange = (e)=>{
      const v = e.target.value;
      // switch syntax mode for model
      if(activeFile && monacoModels[activeFile]){
        monaco.editor.setModelLanguage(monacoModels[activeFile], v === 'javascript' ? 'javascript' : (v==='html'?'html':(v==='python'?'python':(v==='cpp'?'cpp':'plaintext'))));
      }
    };

    // theme toggle
    const themeToggle = document.getElementById('themeToggle');
    themeToggle.onclick = ()=>{
      const body = document.body;
      const cur = body.getAttribute('data-theme');
      const next = cur === 'light' ? 'dark' : 'light';
      body.setAttribute('data-theme', next);
      themeToggle.textContent = next === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
      if(monaco && monaco.editor) monaco.editor.setTheme(next === 'dark' ? 'vs-dark' : 'vs');
    };

    // load project into editor after Monaco ready (monaco init does that)
    // initial autosave indicator
    document.getElementById('autosaveStatus').textContent = 'Ø¬Ø§Ù‡Ø²';
    updateProjectSize();
  });

  /***********************
   * Utilities & finishing touches
   ***********************/
  function highlightActiveFile(){
    const items = document.querySelectorAll('.file-item');
    items.forEach(it=> it.classList.toggle('active', it.textContent === activeFile));
  }

  // Inform user about WASM languages (C++, Java, Go)
  // We add a short notice in terminal on load:
  setTimeout(()=> {
    initConsoleNotice();
  }, 1200);

  function initConsoleNotice(){
    term.writeln('Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¯Ø¹Ù… C++/Java/Go ÙŠØªØ·Ù„Ø¨ WASM toolchain. Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙŠÙˆÙØ± Ø±ÙƒÙŠØ²Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ø¯Ù…Ø¬ Pyodide ÙˆWebContainer. Ù„Ù„Ø§Ø·Ù„Ø§Ø¹ Ø¹Ù„Ù‰ ÙƒÙŠÙÙŠØ© Ø¥Ø¶Ø§ÙØ© C++ Ø¹Ø¨Ø± WASM Ø±Ø§Ø¬Ø¹ README Ø£Ùˆ Ø§Ø³Ø£Ù„Ù†ÙŠ ÙˆØ³Ø£Ø²ÙˆØ¯Ùƒ Ø¨Ø®Ø·ÙˆØ§Øª Ù…ÙØµÙ‘Ù„Ø©.');
  }
  </script>
</body>
</html>